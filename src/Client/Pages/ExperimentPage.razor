@page "/Experiment"
@using ProjectServer.Shared
@inject HttpClient Http
@inject NavigationManager NavigationManager

@if (ExperimentFolder is null)
{
	<LoadingSpinner Message="Loading Experiment..." />
}
else
{
	<div class="px-2 pb-2" style="background-color: #EEEEEE; border-bottom: 1px solid #CCCCCC">
		<div class="p-2">
			<div class="fw-bold fs-3">@ExperimentFolder.Title</div>
			<div class="text-muted">
				@ExperimentFolder.Description
				<a data-bs-toggle="modal" data-bs-target="#editExperimentModal" style="cursor: pointer" @onclick=ExperimentEditorOpened>
					✏️
				</a>
			</div>

			<div>
				<code>@FolderPath</code>
			</div>
		</div>
	</div>

	<div class="m-3">
		<h3 class="">Experiment Notes</h3>
		<div class="mt-3">
			<pre class="font-monospace my-1">@ExperimentFolder.Notes</pre>
		</div>
	</div>

	<div class="m-3">
		<h3>Grouped Cells</h3>
		<div>
			Group by:
			<select @bind=View>
				<option value=@ViewType.ByDay>Day</option>
				<option value=@ViewType.ByColor>Color</option>
				<option value=@ViewType.ByTag>Tag</option>
			</select>
		</div>
	</div>

	<ExperimentEditorModal OnSave=ExperimentEditsSaved @ref="EditorModal" />
}

@if (View == ViewType.ByDay)
{
	if (@ExperimentFolder is not null)
	{
		foreach (AbfFolder folder in ExperimentFolder.AbfFolders)
		{
			string title = "📂 " + Path.GetFileName(folder.FolderPath.Replace("\\", "/"));
			<AbfParentsCard AbfParents=@folder.AbfParents Title=@title Notes=@folder.ExperimentTxt />
		}
	}
}
else if (View == ViewType.ByTag)
{
	HashSet<string> tags = new();
	foreach (var parent in AllParents)
		foreach (var tag in parent.Tags)
			tags.Add(tag);

	foreach (string tag in tags.OrderBy(x => x))
	{
		if (string.IsNullOrWhiteSpace(tag))
		{
			AbfParent[] parentsWithoutTags = AllParents.Where(x => !x.Tags.Any()).ToArray();
			<AbfParentsCard AbfParents=@parentsWithoutTags Title="No Tag" ShowSetpath=true />
		}
		else
		{
			AbfParent[] parentsWithTag = AllParents.Where(x => x.Tags.Contains(tag)).ToArray();
			<AbfParentsCard AbfParents=@parentsWithTag Title=@tag ShowSetpath=true />
		}
	}
}
else if (View == ViewType.ByColor)
{
	foreach (string color in AllParents.Select(x => x.Color).Distinct().OrderBy(x => x))
	{
		AbfParent[] matchingParents = AllParents.Where(x => x.Color == color).ToArray();
		string title = string.IsNullOrWhiteSpace(color) ? "No Color" : $"Color {color}";
		<AbfParentsCard AbfParents=@matchingParents Title=@title BackgroundColor=@color ShowSetpath=true />
	}
}
else
{
	<h3>unsupported view</h3>
}

@code {
	[Parameter]
	[SupplyParameterFromQuery]
	public string FolderPath { get; set; } = string.Empty;

	ExperimentFolder? ExperimentFolder;

	enum ViewType { ByDay, ByTag, ByColor }

	ViewType View { get; set; } = ViewType.ByDay;

	ExperimentEditorModal? EditorModal = null;

	public AbfParent[] AllParents => (ExperimentFolder is null)
		? Array.Empty<AbfParent>()
		: ExperimentFolder.AbfFolders.SelectMany(x => x.AbfParents).ToArray();

	protected override async Task OnInitializedAsync()
	{
		string initialPath = string.IsNullOrEmpty(FolderPath) ? @"X:/Data" : FolderPath;
		await ReloadExperiment(initialPath, false);
	}

	private async Task ReloadExperiment(string path, bool updateUrl)
	{
		path = path.Replace("/", "\\");
		FolderPath = path;

		string apiUrl = "/api/Experiment?path=" + FolderPath;
		ExperimentFolder = await Http.GetFromJsonAsync<ExperimentFolder>(apiUrl);

		if (updateUrl)
			NavigationManager.NavigateTo($"/Experiment?FolderPath={FolderPath}");
	}

	private void ExperimentEditorOpened()
	{
		if (EditorModal is null)
			return;

		if (ExperimentFolder is null)
			return;

		EditorModal.PopulateFields(ExperimentFolder);
	}

	private async Task ExperimentEditsSaved()
	{
		if (EditorModal is null)
			return;

		Shared.DTOs.ExperimentInfo info = EditorModal.GetUpdatedInfo();
		HttpResponseMessage response = await Http.PutAsJsonAsync("/api/Experiment", info);
		Console.WriteLine(response);

		await ReloadExperiment(FolderPath, false);
	}
}